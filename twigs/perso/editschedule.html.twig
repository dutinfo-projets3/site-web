{% extends 'template.html.twig' %}
 {% block stylesheets %}
     <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
     <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
 {% endblock %}
{% block content %}
    <div class=" mt-3 mb-3 p-3 bg-lightcard form-control " id="formulaire">
        <h1 class="card text-center col-md-8 offset-md-2 mb-3 col-12 offset-0">Ajout d'un cours</h1>
        <h4>Selection d'une formation</h4>
        <div class="form-group">
            <select class="custom-select custom-select-lg mb-3" id="selectFormation">
                {% for formation in formations %}
                    <option {% if index.first %}selected {% endif %}
                            value="{{ formation.idFormation }}">{{ formation.nomFormation }}</option>
                {% endfor %}
            </select>
            <div class="invalid-feedback">
                Pas de groupe disponible pour cette formation ou de matière
            </div>
        </div>

        <div style="display: none" id="otherParameters" class="mb-2">
            <h4>Selection d'une date et d'une heure</h4>
            <div class="mb-2 d-flex flex-wrap">
                <label for="datepicker" class="m-2 ml-4 ">Date : </label>
                <input type="text" id="datepicker" class="col-md-2 col-12 form-control">
                <label for="timepickerStart" class="m-2 ml-4">Heure de début : </label>
                <input id="timepickerStart" class="form-control col-md-2 col-12">
                <label for="timepickerEnd" class="m-2 ml-4">Heure de Fin: </label>
                <input id="timepickerEnd" class="form-control  col-md-2 col-12">
                <div class="invalid-feedback">
                    Les heures début et fin ne peuvent être les même et inférieure ou le format n'est pas respecter
                </div>

            </div>

            <h4>Selection d'une matière</h4>
            <select class="custom-select custom-select-lg mb-3" id="selectMatiere">

            </select>

            <h4>Selection d'un groupe</h4>
            <select class="custom-select custom-select-lg mb-3" id="selectGroupe">
            </select>
            <h4>Selection d'un profeseur</h4>
            <select class="custom-select custom-select-lg mb-3" id="selectProfesseurs">
                {% for professeur in professeurs %}
                    <option {% if index.first %}selected {% endif %}
                            value="{{ professeur.id }}"> {{ professeur.nom }} {{ professeur.prenom }}</option>
                {% endfor %}
            </select>
            <h4>Selection d'une salle</h4>
            <select class="custom-select custom-select-lg mb-3" id="selectSalle">>
                {% for salle in salles %}
                    <option
                            value="{{ salle.idsalle }}">Numéro : {{ salle.numero }} / Batiment
                        : {{ salle.batiment }}</option>
                {% endfor %}
            </select>
            <button id="sendInfo" type="button" class="btn btn-primary">Valider</button>
        </div>

    </div>
    <div class="invalid-feedback">
        Veuillez remplir tous les champs
    </div>



{% endblock %}


{% block lnkjavascript %}
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
    <script>
        $(document).ready(function () {

            $("#selectFormation").change(function () {
                var requestGroupe = $.ajax({
                    url: "/api/getGroupeFromFormation.php",
                    method: "POST",
                    data: {idFormation: $(this).val()},
                });

                requestGroupe.done(function (res) {
                    for (i = 0; i < res.groupes.length; i++) {
                        $("#selectGroupe").append(new Option(res.groupes[i].nom, res.groupes[i].idGroupe));
                    }
                    for (i = 0; i < res.matieres.length; i++) {
                        $("#selectMatiere").append(new Option(res.matieres[i].nomMatiere, res.matieres[i].idMatiere));
                    }
                    $("#otherParameters").fadeIn();
                    $("#selectFormation").removeClass("is-invalid");

                });

                requestGroupe.fail(function () {
                    $("#selectFormation").addClass("is-invalid");
                    $("#otherParameters").fadeOut();
                })
            });

            $("#datepicker")
                .datepicker()
                .on("blur paste change onSelect keyup", function () {
                    if (/(^(0?[1-9])|^(1?[0-2]))\/([0-2][0-9]|[3][01])\/([1][9][7-9][0-9]|[2][0-9][0-9][0-9])/.test($(this).val())) {
                        $(this).addClass("is-valid");
                        $(this).removeClass("is-invalid");
                    } else {
                        $(this).removeClass("is-valid");
                        $(this).addClass("is-invalid");
                    }
                });

            $('input#timepickerStart').timepicker({
                timeFormat: 'H:mm ',
                interval: 60,
                minTime: '8',
                maxTime: '18',
                dropdown: true,
                scrollbar: true,
                change: function (time) {
                    if ($("#timepickerEnd").val() != "") {
                        if ($(this).val() == $("#timepickerEnd").val()) {
                            $(this).addClass("is-invalid");
                            $("#timepickerEnd").addClass("is-invalid");
                        }
                        else {
                            if (/[0-9]{1,2}\:[0-9]{2}\ /.test($("#timepickerStart").val()) && parseInt($("#timepickerStart").val().split(":")[0]) < parseInt($("#timepickerEnd").val().split(":")[0])) {
                                $(this).removeClass("is-invalid");
                                $("#timepickerEnd").removeClass("is-invalid");
                                $(this).addClass("is-valid");
                                $("#timepickerEnd").addClass("is-valid");
                            } else {
                                $(this).addClass("is-invalid");
                            }
                        }
                    }
                }

            });

            $('input#timepickerEnd').timepicker({
                timeFormat: 'H:mm ',
                interval: 60,
                minTime: '8',
                maxTime: '18',
                dropdown: true,
                scrollbar: true,
                change: function (time) {
                    if ($("#timepickerStart").val() != "") {
                        if ($(this).val() == $("#timepickerStart").val()) {
                            $(this).addClass("is-invalid");
                            $("#timepickerStart").addClass("is-invalid");
                        } else {
                            if (/[0-9]{1,2}\:[0-9]{2}\ /.test($("#timepickerEnd").val()) && parseInt($("#timepickerEnd").val().split(":")[0]) > parseInt($("#timepickerStart").val().split(":")[0])) {
                                $(this).removeClass("is-invalid");
                                $("#timepickerStart").removeClass("is-invalid");
                                $(this).addClass("is-valid");
                                $("#timepickerStart").addClass("is-valid");
                            } else {
                                $(this).addClass("is-invalid");
                            }
                        }
                    }
                }
            });

            $("#selectGroupe").change(function () {

            });

            $("#sendInfo").click(function () {
                if ($("#datepicker").val() == "" || $("#timepickerStart").val() == "" || $("#timepickerEnd").val() == "") {
                    $("#formulaire").addClass("is-invalid");
                } else {
                    $("#formulaire").removeClass("is-invalid");
                    date = $("#datepicker").val().split("/");
                    hourStart = $("#timepickerStart").val();
                    hourEnd = $("#timepickerEnd").val();
                    hourStart = hourStart.split(":");
                    hourEnd = hourEnd.split(":");
                    dateDebut = date[2] + '-' + date[0] + '-' + date[1] + " " + hourStart[0] + ":00:00";
                    dateF = date[2] + '-' + date[0] + '-' + date[1] + " " + hourEnd[0] + ":00:00";
                    var requestAddSeance = $.ajax({
                        url: "/api/addseance.php",
                        method: "POST",
                        data: {
                            idSalle: $("#selectSalle").val(),
                            idMatiere: $("#selectMatiere").val(),
                            idGroupe: $("#selectGroupe").val(),
                            idProfesseur: $("#selectProfesseurs").val(),
                            dateDeb: dateDebut,
                            dateFin: dateF,
                        },
                    });

                    requestAddSeance.done(function () {
                    })
                }
            });


            $("#selectFormation ").change();
            $("#selectGroupe ").change();
            $("#selectProfesseurs").change();
        })
        ;


    </script>
{% endblock %}